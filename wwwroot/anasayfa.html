<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/anasayfa.css">
    <title>EHRS Anasayfa</title>
</head>
<body>
    <header class="header">
        <a href="anasayfa.html" class="fotograflar">
            <img src="fotograflar/logo.png" alt="Logo">
        </a>
        <nav class="nav">
            <a href="#">Veteriner Hastaneleri</a>
            <a href="#">Özel Klinikler</a>
            <a href="#">Nöbetçi Veterinerler</a>
        </nav>
        <div style="display: flex; align-items: center; gap: 15px;">
            <span id="userName" style="color: #333; font-weight: 600;"></span>
            <button onclick="logout()" style="background: #d32f2f; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">Çıkış Yap</button>
        </div>
    </header>

    <section class="anasayfa">
        <div class="site-inner">
            <a class="content btn-red" href="randevu.html">
                <div class="card">
                    <h3 class="card-title">Hastane Randevusu Al</h3>
                    <p class="desc">Evcil hayvanınız için en yakın veteriner hastanesinden randevu alın.</p>
                </div>
            </a>

            <a class="content btn-blue" href="randevu.html">
                <div class="card">
                    <h3 class="card-title">Özel Klinik Randevusu Al</h3>
                    <p class="desc">Evcil hayvanınız için en yakın özel klinik randevusu alın.</p>
                </div>
            </a>
        </div>
    </section>

    <div class="container">
        <h1 class="title">Randevu Bilgilerim</h1>

        <div class="tabs">
            <button class="tab active" onclick="showTab('current')">Randevularım</button>
            <button class="tab" onclick="showTab('past')">Geçmiş Randevularım</button>
        </div>

        <div id="current" class="tab-content active">
            <div id="currentAppointments">
                <p style="text-align: center; padding: 20px;">Yükleniyor...</p>
            </div>
        </div>

        <div id="past" class="tab-content">
            <div id="pastAppointments">
                <p style="text-align: center; padding: 20px;">Yükleniyor...</p>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://localhost:7116/api';

        // ============================================
        // OTURUM KONTROLÜ
        // ============================================
        function checkSession() {
            const currentUser = sessionStorage.getItem('currentUser') || localStorage.getItem('currentUser');
            if (!currentUser) {
                window.location.href = 'index.html';
                return false;
            }
            return true;
        }

        // ============================================
        // OTURUM KAPAT
        // ============================================
        function logout() {
            if (confirm('Çıkış yapmak istediğinizden emin misiniz?')) {
                sessionStorage.removeItem('currentUser');
                localStorage.removeItem('currentUser');
                window.location.href = 'index.html';
            }
        }

        // ============================================
        // SEKME GÖSTERİMİ
        // ============================================
        function showTab(tabName) {
            document.querySelectorAll(".tab-content").forEach(t => t.classList.remove("active"));
            document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));

            document.getElementById(tabName).classList.add("active");
            event.target.classList.add("active");
        }

        // ============================================
        // RANDEVU YÜKLEMESİ (KULLANICİNİN KENDİ RANDEVULARI)
        // ============================================
        async function loadAppointments() {
            try {
                // Giriş yapan kullanıcının telefon numarasını al
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || localStorage.getItem('currentUser') || '{}');
                const userPhone = currentUser.phone;

                if (!userPhone) {
                    console.error('Kullanıcı telefon numarası bulunamadı');
                    document.getElementById('currentAppointments').innerHTML =
                        '<p style="text-align: center; color: red;">Kullanıcı bilgileri yüklenemedi.</p>';
                    return;
                }

                console.log('📱 Yüklenen telefon:', userPhone);

                // Kullanıcının bekleyen randevuları
                console.log(`📡 ${userPhone} için pending randevular isteniyor...`);
                const pendingResponse = await fetch(`${API_BASE_URL}/Appointment/pending/${userPhone}`);
                console.log('✅ Pending response:', pendingResponse.status);
                const pendingData = await pendingResponse.json();
                console.log('📦 Pending data:', pendingData);
                displayPendingAppointments(pendingData);

                // Kullanıcının tamamlanmış randevuları
                console.log(`📡 ${userPhone} için done randevular isteniyor...`);
                const doneResponse = await fetch(`${API_BASE_URL}/Appointment/done/${userPhone}`);
                console.log('✅ Done response:', doneResponse.status);
                const doneData = await doneResponse.json();
                console.log('📦 Done data:', doneData);
                displayDoneAppointments(doneData);
            } catch (error) {
                console.error('❌ HATA:', error);
                document.getElementById('currentAppointments').innerHTML =
                    '<p style="text-align: center; color: red;">Randevular yüklenirken bir hata oluştu: ' + error.message + '</p>';
                document.getElementById('pastAppointments').innerHTML =
                    '<p style="text-align: center; color: red;">Randevular yüklenirken bir hata oluştu: ' + error.message + '</p>';
            }
        }

        function displayPendingAppointments(appointments) {
            const container = document.getElementById('currentAppointments');

            if (appointments.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px;">Aktif randevunuz bulunmamaktadır.</p>';
                return;
            }

            container.innerHTML = appointments.map(apt => `
                                    <div class="card">
                                        <h3>${apt.PatientName}</h3>
                                        <p><strong>Tarih:</strong> ${formatDate(apt.AppointmentDate)}</p>
                                        <p><strong>Saat:</strong> ${formatTime(apt.AppointmentDate)}</p>
                                        ${apt.DoctorName ? `<p><strong>Doktor:</strong> ${apt.DoctorName}</p>` : ''}
                                        <p><strong>Telefon:</strong> ${apt.MobileNo}</p>
                                        <p><strong>Şehir:</strong> ${apt.City}</p>
                                        <button class="cancel" onclick="cancelAppointment(${apt.AppointmentId})">Randevuyu İptal Et</button>
                                    </div>
                                `).join('');
        }

        function displayDoneAppointments(appointments) {
            const container = document.getElementById('pastAppointments');

            if (appointments.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px;">Geçmiş randevunuz bulunmamaktadır.</p>';
                return;
            }

            container.innerHTML = appointments.map(apt => `
                                    <div class="card">
                                        <h3>${apt.PatientName}</h3>
                                        <p><strong>Tarih:</strong> ${formatDate(apt.AppointmentDate)}</p>
                                        <p><strong>Saat:</strong> ${formatTime(apt.AppointmentDate)}</p>
                                        ${apt.DoctorName ? `<p><strong>Doktor:</strong> ${apt.DoctorName}</p>` : ''}
                                        <p><strong>Telefon:</strong> ${apt.MobileNo}</p>
                                        <p><strong>Durum:</strong> Tamamlandı</p>
                                    </div>
                                `).join('');
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}.${month}.${year}`;
        }

        function formatTime(dateString) {
            const date = new Date(dateString);
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        async function cancelAppointment(appointmentId) {
            if (!confirm('Bu randevuyu iptal etmek istediğinizden emin misiniz?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/Appointment/${appointmentId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('Randevu başarıyla iptal edildi.');
                    loadAppointments();
                } else {
                    const error = await response.json();
                    alert('Randevu iptal edilemedi: ' + (error.message || 'Bilinmeyen hata'));
                }
            } catch (error) {
                console.error('Randevu iptal edilirken hata:', error);
                alert('Randevu iptal edilirken bir hata oluştu.');
            }
        }

        // ============================================
        // SAYFA YÜKLENDİĞİNDE
        // ============================================
        document.addEventListener('DOMContentLoaded', function () {
            // Oturum kontrolü yap
            if (!checkSession()) {
                return;
            }

            // Kullanıcı adını göster
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || localStorage.getItem('currentUser') || '{}');
            if (currentUser.firstName) {
                document.getElementById('userName').textContent = `👤 ${currentUser.firstName} ${currentUser.lastName}`;
            }

            // Randevuları yükle
            loadAppointments();
        });
    </script>
</body>
</html>